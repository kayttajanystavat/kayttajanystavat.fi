<?php
// ei näytetä liittymissivua kirjautuneille käyttäjille
if($onKirjautunut == true)
{
  header('Location: http://kayttajanystavat.fi/etusivu');
  exit;
}

// lomakkeen käsittelyyn liittyviä muuttujien oletusarvoja
$naytaLomake = true;
$virheita = false;
$updatemoodi = false;

// jos on klikattu "Lähetä"...
if (ISSET($_POST["laheta"]))
{
  // sijoitetaan lomakkeen muuttujat saman nimisiin muuttujiin tämmöisen taulukkovirityksen avulla
  // eli saadaan aikaseksi esim. $etunimi-muuttuja, jonka arvo on etunimi-kenttään syötetty arvo
  $lomakeMuuttujat = array("etunimi", "sukunimi", "email", "kotikunta", "puhelin", "jasen_ayy", "jasen_hyy", "jasen_myy", "lisatiedot", "ansa");
  for($i=0; $i<count($lomakeMuuttujat); $i++)
  {
    // eli sijoitus
    $muuttujanNimi = $lomakeMuuttujat[$i];

    // ja sanitointi
    $$muuttujanNimi = mysql_real_escape_string(stripslashes(htmlspecialchars($_POST[$lomakeMuuttujat[$i]])));

    // pituuksien laskeskelu ja muuttujiin sijoittaminen
    // eli saadaan aikaseksi esim. $etunimi_pituus-muuttuja, jonka arvo on merkkijonon pituus (kokonaisluku)
    $muuttujanNimiPituus = $lomakeMuuttujat[$i] . "_pituus";
    $$muuttujanNimiPituus = mb_strlen($$muuttujanNimi);
  }

  // validoidaan syötteet:

  // etunimi
  if($etunimi_pituus < 2)
  {
    $virheita = true;
    $etunimi_virhe = "Etunimi on pakollinen kenttä.";
  }
  if($etunimi_pituus > 32)
  {
    $virheita = true;
    $etunimi_virhe = "Etunimi on liian pitkä ($etunimi_pituus merkkiä). Maksimipituus on 32 merkkiä.";
  }

  // sukunimi
  if($sukunimi_pituus < 2)
  {
    $virheita = true;
    $sukunimi_virhe = "Sukunimi on pakollinen kenttä.";
  }
  if($sukunimi_pituus > 64)
  {
    $virheita = true;
    $sukunimi_virhe = "Sukunimi on liian pitkä ($etunimi_pituus merkkiä). Maksimipituus on 64 merkkiä.";
  }

  // email
  $email_alkuosa = explode("@", $email);
  $email_alkuosa_pituus = mb_strlen($email_alkuosa[0]);
  if (!ereg("^([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$",$email))
  {
    $virheita = true;
    $email_virhe = "Sähköpostiosoite ei ole kelvollinen. Osoitteen tulee olla toimiva ja muotoa <i>tunnus@osoite.fi</i>. ";
  }
  else
  {
    if(($email_alkuosa_pituus > 64) OR ($email_pituus > 256))
    {
      $virheita = true;
      $email_virhe = "Sähköpostiosoite on liian pitkä.";
    }
    else
    {
      // eli osoite on järkevän muotoinen eikä liian pitkä
      // tarkistetaan löytyykö osoitetta kannasta
      $sql_olemassaolevat = "SELECT id, DATEDIFF(NOW(),rek_pvm) AS rek_vrk, rek_aktivoitu from Jasenrekisteri WHERE email='$email'";
      $tulos_olemassaolevat = mysql_query($sql_olemassaolevat) or die('Tietokantahaku epäonnistui ' . mysql_error());
      $lkm_olemassaolevat = mysql_num_rows($tulos_olemassaolevat);
      if($lkm_olemassaolevat > 0)
      {
	   // nyt meillä on ongelma, koska kannasta löytyy jo ko. email-osoite
	   $rivi_olemassaoleva = mysql_fetch_row($tulos_olemassaolevat);
	   $id_olemassaoleva = $rivi_olemassaoleva[0];
	   $rek_vrk_olemassaoleva = $rivi_olemassaoleva[1];
	   $rek_aktivoitu_olemassaoleva = $rivi_olemassaoleva[2];
	   if(($rek_vrk_olemassaoleva > 14) AND ($rek_aktivoitu_olemassaoleva == 0))
	   {
	     // eli jos olemassa oleva tunnari on tehty yli 2 viikkoa sitten eikä sitä ole aktivoitu...
		// sovitaan, että vanha on silloin "poistettu"
		$updatemoodi = true;
	   }
	   else
	   {
	     // eli tunnari on, mutta se on joko alle 2 viikkoa vanha ja/tai on jo aktivoitu
	     $virheita = true;
	     $email_virhe = "Sähköpostiosoite on jo käytössä.";
	     // TODO: kirjoita tähän hyvä ohje kuinka salasanan voi resetoida
	   }
      }
    }
  }

  // kotikunta
  if($kotikunta_pituus < 2)
  {
    $virheita = true;
    $kotikunta_virhe = "Kotikunta on pakollinen kenttä.";
  }
  if($kotikunta_pituus > 32)
  {
    $virheita = true;
    $kotikunta_virhe = "Kotikunnan nimi on liian pitkä ($kotikunta_pituus merkkiä). Maksimipituus on 32 merkkiä.";
  }

  // puhelin
  if($puhelin_pituus > 32)
  {
    $virheita = true;
    $puhelin_virhe = "Puhelinnumero on liian pitkä ($puhelin_pituus merkkiä). Maksimipituus on 32 merkkiä.";
  }

  // lisatiedot
  if($lisatiedot_pituus > 256)
  {
    $virheita = true;
    $lisatiedot_virhe = "Lisätietoja on liikaa ($lisatiedot_pituus merkkiä). Maksimipituus on 256 merkkiä.";
  }

  if($ansa_pituus > 0)
  {
    $virheita = true;
    header('Location: http://kayttajanystavat.fi/etusivu');
    exit;
  }

  if($virheita == false)
  {
    $naytaLomake = false;
    // generoidaan aktivointikoodi
    $aktivointikoodi = $email_alkuosa[0] . md5(uniqid($email, true));
    // kirjoita kantaan
    // $salasana_kantaan = sha1($salasana . "cHej!C+CHu*rat+u");
    if($updatemoodi == true)
    {
      $sql_lisays = "UPDATE Jasenrekisteri SET sukunimi='$sukunimi', etunimi='$etunimi', kotikunta='$kotikunta', puh='$puhelin', ayy_jasen='$jasen_ayy', hyy_jasen='$jasen_hyy', jmyy_jasen='$jasen_myy', rek_pvm=NOW(), rek_koodi='$aktivointikoodi', rek_aktivoitu=0, rek_lisatiedot='$lisatiedot', hyv_pvm=null, viimeksi_kirj=null, onko_admin=0, poistettu=0 WHERE id='$id_olemassaoleva' AND email='$email'";
    }
    else
    {
      $sql_lisays = "INSERT INTO Jasenrekisteri (id, email, sukunimi, etunimi, kotikunta, puh, ayy_jasen, hyy_jasen, jmyy_jasen, rek_pvm, rek_koodi, rek_aktivoitu, rek_lisatiedot, hyv_pvm, viimeksi_kirj, onko_admin, poistettu) VALUES(null, '$email', '$sukunimi', '$etunimi', '$kotikunta', '$puhelin', '$jasen_ayy', '$jasen_hyy', '$jasen_myy', NOW(), '$aktivointikoodi', 0, '$lisatiedot', null, null, 0, 0)";
    }
    mysql_query($sql_lisays) or die("Ongelmia tietojen lisäämisessä tietokantaan." . mysql_error());
    // lähetä sähköposti
    $iposoite = $_SERVER["REMOTE_ADDR"];
    $viim = date('N j.n.Y', strtotime('+14 days'));
    $viim_osat = explode(' ',$viim);
    $viim_paiva = $viim_osat[0];
    $viim_paiva_taulukko = array("maanantaina","tiistaina","keskiviikkona","torstaina","perjantaina","lauantaina","sunnuntaina");
    $viim_paiva_suomeksi = $viim_paiva_taulukko[$viim_paiva - 1];
    $viim_pvm = $viim_osat[1];
    $viimeistaan = $viim_paiva_suomeksi . " " . $viim_pvm;
    $tanaan = date("j.n.Y");
    $vahvistus_to = $email . ", ";
    $otsikko = "[Käyttäjän ystävät] Jäsenhakemusvahvistus";
    $vahvistus_subject = "=?UTF-8?B?".base64_encode($otsikko)."?=";
    $vahvistus_body = "Hei,";
    $vahvistus_body .= "\n\nVahvista Käyttäjän ystävät ry:n jäsenhakemuksesi siirtymällä alla olevaan verkko-osoitteeseen.";
    $vahvistus_body .= "\n\nhttp://kayttajanystavat.fi/vahvista/$aktivointikoodi";
    $vahvistus_body .= "\n\nVahvistus tulee tehdä kahden viikon kuluessa eli viimeistään " . $viimeistaan . ".";
    $vahvistus_body .= "\n\n-- ";
    $vahvistus_body .= "\nKäyttäjän ystävät";
    $lahettaja = "Käyttäjän ystävät";
    $lahettaja_utf8 = "=?UTF-8?B?".base64_encode($lahettaja)."?=";
    $vahvistus_headers = "From:" . $lahettaja_utf8 . "<hallitus@kayttajanystavat.fi>\r\n" . "X-Mailer: php\n";
    if (mail($vahvistus_to, $vahvistus_subject, $vahvistus_body, $vahvistus_headers))
    {
	 $_SESSION['kiitos_email_osoite'] = $email;
	 header('Location: http://kayttajanystavat.fi/liity/kiitos');
	 exit;
    }
    else
    {
      $sposti = "\nHei,";
      $sposti .= "\n\nJäsenhakemuksen vahvistuspyyntöä ei voitu lähettää verkkosivuilta teknisten ongelmien takia, joten ohessa hakemukseni hyväksyttäväksenne.";
      $sposti .= "\n\nEtunimi: $etunimi";
      $sposti .= "\nSukunimi: $sukunimi";
      $sposti .= "\nSähköpostiosoite: $email";
      $sposti .= "\nKotikunta: $kotikunta";
      if($puhelin != "") { $sposti .= "\nPuhelinnumero: $puhelin"; }
      if(($jasen_ayy == "1") OR ($jasen_hyy == "1"))
      {
	   $sposti .= "\nJäsenyys:";
	   if($jasen_ayy == "1") { $sposti .= " AYY"; }
	   if(($jasen_ayy == "1") AND ($jasen_hyy == "1")) { $sposti .= " ja"; }
	   if($jasen_hyy == "1") { $sposti .= " HYY"; }
	 }
      if($lisatietoja != "") { $sposti .= "\nLisätietoja: $lisatietoja"; }

      $sposti_encoded = urlencode($sposti);
      $sposti_encoded = str_replace('+','%20',$sposti_encoded);

      echo "<p>Voi pahus, vahvistuspyynnön lähettämisessä sähköpostitse oli ongelmia.</p>";
      echo "<p>Pahoittelut teknisten ongelmien aiheuttamasta vaivasta. Lähettäisittekö <a href=\"mailto:hallitus@kayttajanystavat.fi?Subject=Liityn%20jäseneksi&Body=$sposti_encoded\">hakemuksenne tiedot hallitukselle sähköpostitse</a>.</p>";
    }
  }
}

if ($naytaLomake == true)
{
?>

<p>Yhdistyksen jäseniksi ovat tervetulleita kaikki käytettävyydestä ja käytettävyysopinnoista kiinnostuneet.
Jäseneksi voi liittyä oheisen lomakkeen täyttämällä.</p>

<p><b>Yhdistys ei peri jäsenmaksua.</b> Tiedotamme mahdollisista muutoksista.</p>

<div id="jasenhakemus">
<h2>Jäsenhakemus</h2>
<form method="post" action="/liity">
<table cellpadding="7">
  <tr>
    <td class="vasen-sarake">Etunimi</td>
    <td class="vaadittu-kentta" title="Pakollinen kenttä">•</td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($etunimi_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($etunimi_virhe)) echo $etunimi_virhe; ?><input type="text" name="etunimi" id="etunimi" maxlength="32" tabindex="1" <?php if($virheita == true) echo "value=\"$etunimi\" "; ?>/></td>
  </tr>
  <tr>
    <td class="vasen-sarake">Sukunimi</td>
    <td class="vaadittu-kentta" title="Pakollinen kenttä">•</td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($sukunimi_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($sukunimi_virhe)) echo $sukunimi_virhe; ?><input type="text" name="sukunimi" id="sukunimi" maxlength="64" tabindex="2" <?php if($virheita == true) echo "value=\"$sukunimi\" "; ?>/></td>
  </tr>
  <tr class="valirivi">
    <td>&nbsp;</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="vasen-sarake"><a class="tooltip tooltip_valkoinen" href="#">Sähköpostiosoite<span class="classic"><p>Sähköpostiosoite lisätään yhdistyksen sähköpostilistalle.</p><p>Rekisteröitymisvahvistus lähetetään annettuun osoitteeseen.</p></span></a></td>
    <td class="vaadittu-kentta" title="Pakollinen kenttä">•</td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($email_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($email_virhe)) echo $email_virhe; ?><input type="text" name="email" id="email" maxlength="64" tabindex="3" <?php if($virheita == true) echo "value=\"$email\" "; ?>/></td>
  </tr>
  <tr class="valirivi">
    <td>&nbsp;</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="vasen-sarake">Kotikunta</td>
    <td class="vaadittu-kentta" title="Pakollinen kenttä">•</td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($kotikunta_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($kotikunta_virhe)) echo $kotikunta_virhe; ?><input type="text" name="kotikunta" id="kotikunta" maxlength="32" tabindex="5" <?php if($virheita == true) echo "value=\"$kotikunta\" "; ?>/></td>
  </tr>
  <tr>
    <td class="vasen-sarake">Puhelinnumero</td>
    <td class="vaadittu-kentta">&nbsp;</td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($puhelin_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($puhelin_virhe)) echo $puhelin_virhe; ?><input type="text" name="puhelin" id="puhelin" maxlength="32" tabindex="6" <?php if($virheita == true) echo "value=\"$puhelin\" "; ?>/></td>
  </tr>
  <tr class="valirivi">
    <td>&nbsp;</td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="vasen-sarake">Jäsenyys</td>
    <td class="vaadittu-kentta">&nbsp;</td>
    <td class="lomake-elementti">
      <input name="jasen_ayy" id="jasen_ayy" type="checkbox" value="1" class="crirHiddenJS" tabindex="7" <?php if(($virheita == true) AND ($jasen_ayy == true)) echo "checked=\"checked\" "; ?>/>
      <label for="jasen_ayy">Aalto-yliopiston ylioppilaskunta</label><br />
      <input name="jasen_hyy" id="jasen_hyy" type="checkbox" value="1" class="crirHiddenJS" tabindex="8" <?php if(($virheita == true) AND ($jasen_hyy == true)) echo "checked=\"checked\" "; ?>/>
      <label for="jasen_hyy">Helsingin yliopiston ylioppilaskunta</label><br />
	<input name="jasen_myy" id="jasen_myy" type="checkbox" value="1" class="crirHiddenJS" tabindex="9" <?php if(($virheita == true) AND ($jasen_myy == true)) echo "checked=\"checked\" "; ?>/>
      <label for="jasen_myy">Muu ylioppilas- tai opiskelijakunta</label>
    </td>
  </tr>
  <tr>
    <td class="vasen-sarake">Lisätiedot</td>
    <td class="vaadittu-kentta"></td>
    <td class="lomake-elementti<?php if(($virheita == true) AND ISSET($lisatiedot_virhe)) echo "-virhe"; ?>"><?php if(($virheita == true) AND ISSET($lisatiedot_virhe)) echo $lisatiedot_virhe; ?><textarea name="lisatiedot" id="lisatiedot" tabindex="9" /><?php if($virheita == true) echo $_POST["lisatiedot"]; ?></textarea></td>
  </tr>
  <tr class="ansa">
    <td class="vasen-sarake">Ihmisyystarkistus (jätä kenttä tyhjäksi!)</td>
    <td class="vaadittu-kentta"></td>
    <td class="lomake-elementti"><input type="text" name="ansa" id="ansa" maxlength="32" /></td>
  </tr>
  <tr>
    <td class="vasen-sarake">&nbsp;</td>
    <td class="vaadittu-kentta">&nbsp;</td>
    <td class="lomake-elementti"><input type="submit" name="laheta" id="laheta" value="Lähetä" tabindex="10" /><span id="spinner"><img id="latauskuvake" src="/images/ajax-loader-lomake.gif" alt="Hetkinen..."/></span></td>
  </tr>
</table>
</form>
</div>
<p>Merkityt (•) kentät ovat pakollisia.</p>
<p>Henkilötietolain edellyttämä <a href="http://kayttajanystavat.fi/rekisteriseloste">rekisteriseloste</a>.</p>
<?php
}
?>
